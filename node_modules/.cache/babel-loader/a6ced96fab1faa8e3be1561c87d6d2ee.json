{"ast":null,"code":"//@ts-nocheck\nimport { Contract, ethers } from \"ethers\";\nimport { getTonumber } from \"../utils/formatBalance\";\nimport { getDefaultProvider } from \"../utils/provider\";\nimport ERC20 from \"./ERC20\";\n/**\n * An API module of Gaea Coin contracts.\n * All contract-interacting domain logic should be defined in here.\n */\n\nexport class BasisCash {\n  constructor(cfg) {\n    this.myAccount = void 0;\n    this.provider = void 0;\n    this.signer = void 0;\n    this.config = void 0;\n    this.contracts = void 0;\n    this.externalTokens = void 0;\n    const {\n      deployments,\n      externalTokens\n    } = cfg;\n    const provider = getDefaultProvider(); // loads contracts from deployments\n\n    this.contracts = {};\n\n    for (const [name, deployment] of Object.entries(deployments)) {\n      this.contracts[name] = new Contract(deployment.address, deployment.abi, provider);\n    }\n\n    this.externalTokens = {};\n\n    for (const [symbol, [address, decimal]] of Object.entries(externalTokens)) {\n      this.externalTokens[symbol] = new ERC20(address, provider, symbol, decimal); // TODO: add decimal\n    }\n\n    this.config = cfg;\n    this.provider = provider;\n  }\n  /**\n   * @param provider From an unlocked wallet. (e.g. Metamask)\n   * @param account An address of unlocked wallet account.\n   */\n\n\n  unlockWallet(provider, account) {\n    const newProvider = new ethers.providers.Web3Provider(provider, this.config.chainId);\n    this.signer = newProvider.getSigner(0);\n    this.myAccount = account;\n\n    for (const [name, contract] of Object.entries(this.contracts)) {\n      this.contracts[name] = contract.connect(this.signer);\n    }\n\n    const tokens = [...Object.values(this.externalTokens)];\n\n    for (const token of tokens) {\n      token.connect(this.signer);\n    }\n  }\n\n  get isUnlocked() {\n    return !!this.myAccount;\n  }\n\n  gasOptions() {\n    return {\n      // gasLimit: 300000000,\n      from: this.myAccount\n    };\n  }\n\n  async getStaked(depositToken, account = this.myAccount) {\n    try {\n      const {\n        Mine\n      } = this.contracts;\n      const {\n        address\n      } = depositToken;\n      let staked = await Mine.getBalance(address, account);\n      return staked;\n    } catch (error) {\n      return \"0\";\n    }\n  }\n\n  async getEarned(depositToken, account = this.myAccount) {\n    try {\n      const {\n        Mine\n      } = this.contracts;\n      const {\n        address\n      } = depositToken;\n      let earned = await Mine.getAccountReward(address, account);\n      return getTonumber(earned);\n    } catch (error) {\n      return \"0\";\n    }\n  }\n\n  async getChannelInfo(depositToken, block) {\n    try {\n      const {\n        Mine\n      } = this.contracts;\n      const {\n        address\n      } = depositToken;\n      let info = await Mine.getChannelInfo(address);\n      const endBlock = info.endBlock.toNumber();\n      return {\n        rewardRate: block > endBlock ? 0 : getTonumber(info.rewardRate),\n        totalSupply: getTonumber(info.totalSupply)\n      };\n    } catch (error) {\n      return \"0\";\n    }\n  }\n\n  async stake(amount, poolName, pid) {\n    try {\n      const pool = this.contracts[poolName];\n      return await pool.deposit(pid, amount, this.gasOptions());\n    } catch (error) {\n      console.log(\"ðŸš€ ~ file: BasisCash.ts ~ line 126 ~ BasisCash ~ stake ~ error\", error, amount, poolName, pid);\n    }\n  }\n\n  async unstake(amount, poolName, pid) {\n    const pool = this.contracts[poolName];\n    console.log(\"ðŸš€ ~ file: BasisCash.ts ~ line 91 ~ BasisCash ~ unstake ~ amount\", amount);\n    return await pool.withdraw(pid, amount, this.gasOptions());\n  }\n\n  async harvest(poolName, pid) {\n    const pool = this.contracts[poolName];\n    return await pool.getReward(pid, 0, this.gasOptions());\n  }\n\n}","map":{"version":3,"sources":["/Users/miczero/ParaAsset/src/basis-cash/BasisCash.ts"],"names":["Contract","ethers","getTonumber","getDefaultProvider","ERC20","BasisCash","constructor","cfg","myAccount","provider","signer","config","contracts","externalTokens","deployments","name","deployment","Object","entries","address","abi","symbol","decimal","unlockWallet","account","newProvider","providers","Web3Provider","chainId","getSigner","contract","connect","tokens","values","token","isUnlocked","gasOptions","from","getStaked","depositToken","Mine","staked","getBalance","error","getEarned","earned","getAccountReward","getChannelInfo","block","info","endBlock","toNumber","rewardRate","totalSupply","stake","amount","poolName","pid","pool","deposit","console","log","unstake","withdraw","harvest","getReward"],"mappings":"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","sourcesContent":["//@ts-nocheck\n\nimport { Configuration } from \"./config\";\nimport { Contract, ethers, Overrides } from \"ethers\";\nimport {\n  getDisplayNumber,\n  getToBignumber,\n  getTonumber,\n} from \"../utils/formatBalance\";\nimport { getDefaultProvider } from \"../utils/provider\";\nimport ERC20 from \"./ERC20\";\n/**\n * An API module of Gaea Coin contracts.\n * All contract-interacting domain logic should be defined in here.\n */\nexport class BasisCash {\n  myAccount: string;\n  provider: ethers.providers.Web3Provider;\n  signer?: ethers.Signer;\n  config: Configuration;\n  contracts: { [name: string]: Contract };\n  externalTokens: { [name: string]: ERC20 };\n\n  constructor(cfg: Configuration) {\n    const { deployments, externalTokens } = cfg;\n    const provider = getDefaultProvider();\n\n    // loads contracts from deployments\n    this.contracts = {};\n    for (const [name, deployment] of Object.entries(deployments)) {\n      this.contracts[name] = new Contract(\n        deployment.address,\n        deployment.abi,\n        provider\n      );\n    }\n    this.externalTokens = {};\n    for (const [symbol, [address, decimal]] of Object.entries(externalTokens)) {\n      this.externalTokens[symbol] = new ERC20(\n        address,\n        provider,\n        symbol,\n        decimal\n      ); // TODO: add decimal\n    }\n\n    this.config = cfg;\n    this.provider = provider;\n  }\n\n  /**\n   * @param provider From an unlocked wallet. (e.g. Metamask)\n   * @param account An address of unlocked wallet account.\n   */\n  unlockWallet(provider: any, account: string) {\n    const newProvider = new ethers.providers.Web3Provider(\n      provider,\n      this.config.chainId\n    );\n\n    this.signer = newProvider.getSigner(0);\n    this.myAccount = account;\n    for (const [name, contract] of Object.entries(this.contracts)) {\n      this.contracts[name] = contract.connect(this.signer);\n    }\n    const tokens = [...Object.values(this.externalTokens)];\n    for (const token of tokens) {\n      token.connect(this.signer);\n    }\n  }\n\n  get isUnlocked(): boolean {\n    return !!this.myAccount;\n  }\n\n  gasOptions() {\n    return {\n      // gasLimit: 300000000,\n      from: this.myAccount,\n    };\n  }\n\n  async getStaked(depositToken, account = this.myAccount) {\n    try {\n      const { Mine } = this.contracts;\n      const { address } = depositToken;\n      let staked = await Mine.getBalance(address, account);\n      return staked;\n    } catch (error) {\n      return \"0\";\n    }\n  }\n  async getEarned(depositToken, account = this.myAccount) {\n    try {\n      const { Mine } = this.contracts;\n      const { address } = depositToken;\n      let earned = await Mine.getAccountReward(address, account);\n      return getTonumber(earned);\n    } catch (error) {\n      return \"0\";\n    }\n  }\n  async getChannelInfo(depositToken, block) {\n    try {\n      const { Mine } = this.contracts;\n      const { address } = depositToken;\n      let info = await Mine.getChannelInfo(address);\n      const endBlock = info.endBlock.toNumber();\n      return {\n        rewardRate: block > endBlock ? 0 : getTonumber(info.rewardRate),\n        totalSupply: getTonumber(info.totalSupply),\n      };\n    } catch (error) {\n      return \"0\";\n    }\n  }\n\n  async stake(amount, poolName, pid) {\n    try {\n      const pool = this.contracts[poolName];\n      return await pool.deposit(pid, amount, this.gasOptions());\n    } catch (error) {\n      console.log(\n        \"ðŸš€ ~ file: BasisCash.ts ~ line 126 ~ BasisCash ~ stake ~ error\",\n        error,\n        amount,\n        poolName,\n        pid\n      );\n    }\n  }\n\n  async unstake(amount, poolName, pid) {\n    const pool = this.contracts[poolName];\n    console.log(\n      \"ðŸš€ ~ file: BasisCash.ts ~ line 91 ~ BasisCash ~ unstake ~ amount\",\n      amount\n    );\n    return await pool.withdraw(pid, amount, this.gasOptions());\n  }\n\n  async harvest(poolName, pid) {\n    const pool = this.contracts[poolName];\n    return await pool.getReward(pid, 0, this.gasOptions());\n  }\n}\n"]},"metadata":{},"sourceType":"module"}